const { chromium } = require('playwright');
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

const askQuestion = (query) => new Promise(resolve => rl.question(query, resolve));

(async () => {
  console.log("\nüöÄ Launching Browser on GitHub Server...");
  const browser = await chromium.launch({ headless: true });
  const context = await browser.newContext();
  const page = await context.newPage();

  try {
    // 1Ô∏è‚É£ Go directly to the Login/Welcome page
    console.log("üåç Navigating to Wishlink Welcome Page...");
    await page.goto('https://creator.wishlink.com/welcome', { waitUntil: 'networkidle', timeout: 60000 });

    // 2Ô∏è‚É£ Handle Country Selection (Force India)
    console.log("üáÆüá≥ Checking Country Code...");
    
    // Check if +91 is not selected
    const countryText = await page.textContent('body'); // simplistic check, real check below
    
    // Try to click the country dropdown (it usually has the flag or +XX)
    // We look for the dropdown trigger next to the phone input
    const countryDropdown = page.locator('.flag-dropdown, [class*="selected-flag"], div[role="button"]:has-text("+")').first();
    
    if (await countryDropdown.isVisible()) {
        await countryDropdown.click();
        console.log("üëâ Opened Country List. Selecting India...");
        
        // Click "India" from the list
        const indiaOption = page.locator('li, div').filter({ hasText: /^India$/i }).first();
        // Fallback: search for +91 text
        const indiaCode = page.locator('li, div').filter({ hasText: '+91' }).first();
        
        if (await indiaOption.isVisible()) {
            await indiaOption.click();
        } else if (await indiaCode.isVisible()) {
            await indiaCode.click();
        }
        console.log("‚úÖ Country set to India (+91)");
    }

    // 3Ô∏è‚É£ Enter Phone Number
    const phoneInput = page.getByPlaceholder(/enter phone number/i);
    await phoneInput.waitFor({ state: 'visible', timeout: 30000 });
    
    const phone = await askQuestion("\nüì± Enter your Mobile Number (10 digits only): ");
    await phoneInput.fill(phone);

    // 4Ô∏è‚É£ Click Get OTP
    console.log("üëÜ Clicking Get OTP...");
    const otpBtn = page.getByRole('button', { name: /get otp/i });
    await otpBtn.click();

    // 5Ô∏è‚É£ Enter OTP
    console.log("\nüì© OTP Sent! Check your phone.");
    const otp = await askQuestion("üîë Enter the 6-digit OTP: ");
    
    // Wait for OTP input boxes (usually 6 boxes or 1 main box)
    // We try to find the input and type
    const otpInput = page.locator('input[autocomplete="one-time-code"], input[type="number"]').first();
    await otpInput.waitFor({ state: 'visible', timeout: 30000 });
    await otpInput.fill(otp);

    // 6Ô∏è‚É£ Auto-Verify or Click Verify
    console.log("‚è≥ Verifying...");
    // Sometimes it auto-submits, sometimes we need to click
    try {
        const verifyBtn = page.getByRole('button', { name: /verify/i });
        if (await verifyBtn.isVisible()) {
            await verifyBtn.click();
        }
    } catch (e) {}

    // 7Ô∏è‚É£ Wait for Dashboard
    console.log("‚è≥ Waiting for Dashboard...");
    await page.waitForTimeout(5000); 
    
    // 8Ô∏è‚É£ Capture Session
    console.log("‚úÖ Login Successful! Capturing Session...");
    const storageState = await context.storageState();
    
    console.log("\nüëá COPY THE JSON BELOW THIS LINE üëá\n");
    console.log(JSON.stringify(storageState));
    console.log("\nüëÜ COPY THE JSON ABOVE THIS LINE üëÜ\n");

  } catch (error) {
    console.error("‚ùå Error:", error.message);
    // Debug: Take screenshot on error to see what happened
    await page.screenshot({ path: 'debug_error.png' });
    console.log("üì∏ Error screenshot saved (you can't see it, but I took it).");
  } finally {
    await browser.close();
    rl.close();
    process.exit(0);
  }
})();
